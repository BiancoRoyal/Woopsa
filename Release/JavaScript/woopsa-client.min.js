!function(i){var t=function(){},n=function(i,n,e,s,r,u){this.channel=i,this.path=n,this.onChange=e||t,this.subscriptionId=null,r=r||.02,u=u||.05,s=s||t,this.unregister=function(t){return i.client.invoke("/SubscriptionService/UnregisterSubscription",{SubscriptionChannel:i.channelId,SubscriptionId:this.subscriptionId},function(i){t()}.bind(this))},this.register=function(t){return i.client.invoke("/SubscriptionService/RegisterSubscription",{SubscriptionChannel:i.channelId,PropertyLink:n,MonitorInterval:r,PublishInterval:u},function(i){this.subscriptionId=i,s(this),t&&t(this)}.bind(this))},this.register.call(this)},e=function(i,t,e){this.client=i,this.onCreate=e,this.channelId=null,this.subscriptions=[],this.listenStarted=!1,this.subscriptionsDictionary={};var s=!1,r=0;this.registerSubscription=function(i,t,e,s,r){var u=new n(this,i,t,function(i){this.subscriptionsDictionary[u.subscriptionId]=u,e(i)}.bind(this),s,r);return this.subscriptions.push(u),this.listenStarted||(this.listenStarted=!0,o.call(this)),u},this.unregisterSubscription=function(i,t){var n=this.subscriptions.indexOf(i);-1!=n&&this.subscriptions[n].unregister(function(i,t){this.subscriptions.splice(i,1),t()}.bind(this,n,t))},this.register=function(){return i.invoke("/SubscriptionService/CreateSubscriptionChannel",{NotificationQueueSize:t},function(i){this.channelId=i,s||this.onCreate.call(this,this.channelId),s=!0}.bind(this))},this.register.call(this);var u=1e4,o=function(t){return"undefined"==typeof t&&(t=r),i.invoke("/SubscriptionService/WaitNotification",{SubscriptionChannel:this.channelId,LastNotificationId:t},function(i){for(var t=0;t<i.length;t++){var n=i[t];this.subscriptionsDictionary[n.SubscriptionId]&&(this.subscriptionsDictionary[n.SubscriptionId].onChange(n.Value.Value),n.Id>r&&(r=n.Id))}o.call(this)}.bind(this)).fail(function(i,t,n){if(4==i.readyState){if("application/json"==i.getResponseHeader("Content-Type")){var e=JSON.parse(i.responseText);"WoopsaInvalidSubscriptionChannelException"==e.Type?(this.register().done(function(){for(var i=0;i<this.subscriptions.length;i++)this.subscriptions[i].register()}.bind(this)),setTimeout(function(){o.call(this,r)}.bind(this),u)):"WoopsaNotificationsLostException"==e.Type&&o.call(this,0)}}else setTimeout(function(){o.call(this,r)}.bind(this),u)}.bind(this))}};i.WoopsaClient=function(i,t){function n(i,t){for(var n=0;n<o.length;n++)o[n](i,t)}function s(i){null!=this.username&&i.setRequestHeader("Authorization","Basic "+btoa(this.username+":"+this.password))}var r=t,u=null,o=[],a=function(i){var t=r.ajax(i);return t},c=function(i){var t=[],n=[],e=[],i=i||{},s=null;this.done=function(i){return null!=s?s.done(i):t.push(i),this},this.fail=function(i){return null!=s?s.fail(i):n.push(i),this},this.then=function(i,e){return null!=s?(s.done(callback),s.fail(callback)):(t.push(i),n.push(e)),this},this.always=function(i){return null!=s?s.always(i):e.push(i),this},this.execute=function(){s=new a(i),s.done(function(i,t,n){isDone=!0,doneData=i,doneTextStatus=t,donejqXHR=n}),s.fail(function(i,t,n){isFail=!0,donejqXHR=i,doneTextStatus=t,failErrorThrown=n});for(var r=0;r<t.length;r++)s.done(t[r]);for(var r=0;r<n.length;r++)s.fail(n[r]);for(var r=0;r<e.length;r++)s.always(e[r]);return s}},h=[],l=function(i,t){if(t){var n=new c(i);return n.always(function(){h.splice(0,1),h.length>0&&h[0].execute()}),h.push(n),1==h.length&&n.execute(),n}return new a(i)};i.lastIndexOf("/")==i.length-1?this.url=i:this.url=i+"/",this.username=null,this.password=null,this.useRequestQueue=!1,this.read=function(i,t){return l({type:"GET",url:this.url+"read"+i,beforeSend:s.bind(this)},this.useRequestQueue).done(function(n){t(n.Value,i)}).fail(function(i,t,e){n(t,e)})},this.write=function(i,t,e){return l({type:"POST",url:this.url+"write"+i,beforeSend:s.bind(this),data:{value:t}},this.useRequestQueue).done(function(t){e(!0,i)}).fail(function(i,t,e){n(t,e)})},this.meta=function(i,t){return l({type:"GET",url:this.url+"meta"+i,beforeSend:s.bind(this)},this.useRequestQueue).done(function(n){t(n,i)}).fail(function(i,t,e){n(t,e)})},this.invoke=function(i,t,e,r){return r=r||1e4,t=t||{},e=e||function(){},l({type:"POST",timeout:r,beforeSend:s.bind(this),url:this.url+"invoke"+i,data:t,dataType:"text"},this.useRequestQueue).done(function(i){""==i?e():e(JSON.parse(i).Value)}).fail(function(i,t,e){n(t,e)})},this.multiRequest=function(i,t){for(var n={},e=[],s=0;s<i.length;s++){var r=i[s];n[r.Id]=r,e.push({Id:r.Id,Verb:r.Verb,Path:r.Path,Value:r.Value,Arguments:r.Arguments})}return this.invoke("/MultiRequest",{Requests:JSON.stringify(e)},function(i){for(var e=0;e<i.length;e++){var s=i[e],r=n[s.Id];r.callback&&r.callback(s.Result)}t(i)}.bind(this))},this.createSubscriptionChannel=function(i,t){if(null!=u)return void t.call(u,u.channelId);var n=new e(this,i,function(i){t.call(this,i)});return u=n,n};var f=!1,d=[];this.onChange=function(i,t,n,e,s){var r=s;return"function"==typeof n&&(r=n),f?void d.push({path:i,callback:t,monitorInterval:n,publishInterval:e,successCallback:r}):void(null!=u||f?u.registerSubscription(i,t,s,n,e):(f=!0,this.createSubscriptionChannel(200,function(){this.onChange(i,t,n,e,r),f=!1;for(var s=d.length-1;s>=0;s--){var o=d[s];u.registerSubscription(o.path,o.callback,o.successCallback,o.monitorInterval,o.publishInterval),d.splice(s,1)}}.bind(this))))},this.onError=function(i){o.push(i)}}}(window);